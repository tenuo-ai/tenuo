name: Release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Publish Rust crate to crates.io
  publish-crate:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Verify crate builds
        working-directory: tenuo-core
        run: cargo build --release

      - name: Run tests
        working-directory: tenuo-core
        run: cargo test --release

      - name: Publish to crates.io
        working-directory: tenuo-core
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Build wheels for each platform (abi3 = one wheel per OS)
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: tenuo-python
        run: maturin build --release

      - name: Upload wheel
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: wheel-${{ matrix.os }}
          path: tenuo-python/target/wheels/*.whl
          if-no-files-found: error

  # Build source distribution
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install maturin
        run: pip install maturin

      - name: Build sdist
        working-directory: tenuo-python
        run: maturin sdist

      - name: Upload sdist
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sdist
          path: tenuo-python/target/wheels/*.tar.gz
          if-no-files-found: error

  # Publish to PyPI
  publish:
    name: Publish to PyPI
    needs: [build, sdist]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wheel-ubuntu-latest
          path: dist/

      - name: Download macOS wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wheel-macos-latest
          path: dist/

      - name: Download Windows wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: wheel-windows-latest
          path: dist/

      - name: Download sdist
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: sdist
          path: dist/

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # v1.12.4
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          packages-dir: dist/
          skip-existing: true

  # Build and push Docker images to Docker Hub
  docker:
    name: Push Docker images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Login to Docker Hub
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Authorizer image
      - name: Docker metadata (Authorizer)
        id: meta-authorizer
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          images: tenuo/authorizer
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Authorizer
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./tenuo-core
          file: ./tenuo-core/deploy/docker/Dockerfile.authorizer
          push: true
          tags: ${{ steps.meta-authorizer.outputs.tags }}
          labels: ${{ steps.meta-authorizer.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Control Plane image
      - name: Docker metadata (Control)
        id: meta-control
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          images: tenuo/control
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Control Plane
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./tenuo-core
          file: ./tenuo-core/deploy/docker/Dockerfile.control
          push: true
          tags: ${{ steps.meta-control.outputs.tags }}
          labels: ${{ steps.meta-control.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
