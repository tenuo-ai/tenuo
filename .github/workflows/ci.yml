name: CI

on:
  push:
    branches: [ "main", "camel" ]
  pull_request:
    branches: [ "main", "camel" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # RUST CORE
  # ============================================================================
  rust-core:
    name: Rust Core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: tenuo-core

      - name: Check Formatting
        run: cargo fmt --all -- --check
        working-directory: tenuo-core

      - name: Lint with Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: tenuo-core

      - name: Run Tests
        run: cargo test --all-features
        working-directory: tenuo-core

      - name: Security Audit
        working-directory: tenuo-core
        run: |
          cargo install cargo-audit --locked
          cargo audit

  # ============================================================================
  # PYTHON SDK - Matrix Testing
  # ============================================================================
  python-sdk:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: tenuo-python
          key: ${{ matrix.os }}-${{ matrix.python-version }}

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: pip install uv

      - name: Create venv
        run: uv venv

      - name: Build and Install Tenuo (Unix)
        if: runner.os != 'Windows'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          pip install maturin
          maturin develop
          pip install -e .

      - name: Build and Install Tenuo (Windows)
        if: runner.os == 'Windows'
        working-directory: tenuo-python
        shell: bash
        run: |
          source ../.venv/Scripts/activate
          pip install maturin
          maturin develop
          pip install -e .

      - name: Install dev dependencies (Unix)
        if: runner.os != 'Windows'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          uv pip install pytest ruff mypy langchain langchain-core langchain-openai langgraph fastapi uvicorn pydantic PyYAML types-PyYAML types-requests

      - name: Install dev dependencies (Windows)
        if: runner.os == 'Windows'
        working-directory: tenuo-python
        shell: bash
        run: |
          source ../.venv/Scripts/activate
          uv pip install pytest ruff mypy langchain langchain-core langchain-openai langgraph fastapi uvicorn pydantic PyYAML types-PyYAML types-requests

      - name: Lint with Ruff (Unix)
        if: runner.os != 'Windows'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          ruff check .

      - name: Lint with Ruff (Windows)
        if: runner.os == 'Windows'
        working-directory: tenuo-python
        shell: bash
        run: |
          source ../.venv/Scripts/activate
          ruff check .

      - name: Type Check with MyPy (Unix)
        if: runner.os != 'Windows'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          mypy .

      - name: Type Check with MyPy (Windows)
        if: runner.os == 'Windows'
        working-directory: tenuo-python
        shell: bash
        run: |
          source ../.venv/Scripts/activate
          mypy .

      - name: Run Tests (Unix)
        if: runner.os != 'Windows'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          pytest

      - name: Run Tests (Windows)
        if: runner.os == 'Windows'
        working-directory: tenuo-python
        shell: bash
        run: |
          source ../.venv/Scripts/activate
          pytest

  # ============================================================================
  # LANGCHAIN COMPATIBILITY - Test oldest and latest versions
  # ============================================================================
  langchain-compat:
    name: LangChain ${{ matrix.langchain-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        langchain-version: ['0.2.0', 'latest']
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: tenuo-python

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install uv
        run: pip install uv

      - name: Create venv
        run: uv venv

      - name: Build and Install Tenuo
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          pip install maturin
          maturin develop
          pip install -e .

      - name: Install LangChain (oldest)
        if: matrix.langchain-version == '0.2.0'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          uv pip install pytest langchain-core==0.2.0 pydantic PyYAML

      - name: Install LangChain (latest)
        if: matrix.langchain-version == 'latest'
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          uv pip install pytest langchain langchain-core langchain-openai langgraph pydantic PyYAML

      - name: Run LangChain Integration Tests
        working-directory: tenuo-python
        run: |
          source ../.venv/bin/activate
          pytest tests/ -k "langchain or langgraph" -v

  # ============================================================================
  # DOCKER
  # ============================================================================
  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Control Plane
        uses: docker/build-push-action@v5
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.control
          push: false
          tags: tenuo/control:test
          cache-from: type=gha,scope=control
          cache-to: type=gha,mode=max,scope=control

      - name: Build Authorizer
        uses: docker/build-push-action@v5
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.authorizer
          push: false
          tags: tenuo/authorizer:test
          cache-from: type=gha,scope=authorizer
          cache-to: type=gha,mode=max,scope=authorizer

      - name: Build Agents (Demo)
        uses: docker/build-push-action@v5
        with:
          context: tenuo-core
          file: tenuo-core/demo/docker/Dockerfile.agents
          push: false
          tags: tenuo/agents:test
          cache-from: type=gha,scope=agents
          cache-to: type=gha,mode=max,scope=agents
