name: CI

on:
  push:
    branches: [main, camel]
  pull_request:
    branches: [main, camel]
  workflow_dispatch:

# Restrict permissions to minimum required
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0  # Faster CI builds (no incremental overhead)

jobs:
  # ============================================================================
  # RUST CORE
  # ============================================================================
  rust-core:
    name: Rust Core
    runs-on: ubuntu-latest
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      # Pin to specific commit for security (update periodically)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Configure mold linker
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-core

      - name: Check Cargo.lock
        run: cargo check --locked
        working-directory: tenuo-core

      - name: Format tenuo-core
        run: cargo fmt --all -- --check
        working-directory: tenuo-core

      - name: Format tenuo-python
        run: cargo fmt --all -- --check
        working-directory: tenuo-python

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: tenuo-core

      - name: Test
        run: cargo test --all-features
        working-directory: tenuo-core

      - name: Validate test vectors
        run: |
          GENERATED=$(cargo run --bin generate_test_vectors 2>/dev/null)
          COMMITTED=$(cat ../docs/spec/test-vectors.md)
          if ! diff -b <(echo "$GENERATED") <(echo "$COMMITTED") > /dev/null 2>&1; then
            echo "ERROR: docs/spec/test-vectors.md is out of sync with generator"
            echo "Run: cd tenuo-core && cargo run --bin generate_test_vectors > ../docs/spec/test-vectors.md"
            diff -u <(echo "$COMMITTED") <(echo "$GENERATED") | head -100
            exit 1
          fi
          echo "OK: test-vectors.md is up to date"
        working-directory: tenuo-core

  # ============================================================================
  # PYTHON SDK
  # ============================================================================
  python-sdk:
    name: Python ${{ matrix.python-version }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Full Python version testing on Linux x64, key versions on other platforms/archs
        include:
          # Linux x64: full version matrix
          - os: ubuntu-latest
            python-version: "3.9"
          - os: ubuntu-latest
            python-version: "3.10"
          - os: ubuntu-latest
            python-version: "3.11"
          - os: ubuntu-latest
            python-version: "3.12"
          - os: ubuntu-latest
            python-version: "3.13"
          - os: ubuntu-latest
            python-version: "3.14"
          # Linux ARM64: min and latest
          - os: ubuntu-24.04-arm
            python-version: "3.9"
          - os: ubuntu-24.04-arm
            python-version: "3.14"
          # macOS ARM64 (Apple Silicon): full range
          - os: macos-latest
            python-version: "3.9"
          - os: macos-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.13"
          - os: macos-latest
            python-version: "3.14"
          # Windows x64: full range
          - os: windows-latest
            python-version: "3.9"
          - os: windows-latest
            python-version: "3.12"
          - os: windows-latest
            python-version: "3.13"
          - os: windows-latest
            python-version: "3.14"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python
          key: ${{ matrix.os }}-py${{ matrix.python-version }}

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo and dependencies
        working-directory: tenuo-python
        run: |
          pip install uv
          uv pip install --system maturin
          echo "=== Building wheel ==="
          maturin build --release
          echo "=== Wheel files ==="
          ls -la target/wheels/
          echo "=== Wheel contents ==="
          python -c "import zipfile; z=zipfile.ZipFile(list(__import__('pathlib').Path('target/wheels').glob('*.whl'))[0]); print('\n'.join(z.namelist()[:30]))"
          echo "=== Installing wheel ==="
          uv pip install --system target/wheels/*.whl
          echo "=== Pip show tenuo ==="
          uv pip show tenuo || echo "tenuo not found in pip"
          echo "=== Site packages ==="
          ls -la $(python -c "import site; print(site.getsitepackages()[0])") | head -20
          echo "=== Installing other deps ==="
          uv pip install --system pytest pytest-asyncio ruff mypy
          uv pip install --system langchain langchain-core langchain-openai langgraph
          uv pip install --system fastapi uvicorn pydantic PyYAML
          uv pip install --system types-PyYAML types-requests
          # Install crewai for integration tests (Python 3.10+)
          python -c "import sys; sys.exit(0 if sys.version_info >= (3, 10) else 1)" && uv pip install --system crewai || echo "Skipping crewai (requires Python 3.10+)"
          # MCP SDK requires Python 3.10+
          python -c "import sys; sys.exit(0 if sys.version_info >= (3, 10) else 1)" && uv pip install --system mcp || echo "Skipping MCP (requires Python 3.10+)"

      - name: Verify import
        run: |
          echo "=== Checking if tenuo_core exists ==="
          python -c "import tenuo_core; print('tenuo_core OK')" || echo "tenuo_core not found"
          echo "=== Checking if tenuo exists ==="
          python -c "import tenuo; print(f'tenuo {tenuo.__version__} from {tenuo.__file__}')"

      - name: Lint
        working-directory: tenuo-python
        run: ruff check .

      - name: Type check
        working-directory: tenuo-python
        run: mypy .

      - name: Test
        working-directory: tenuo-python
        run: pytest -v

  # ============================================================================
  # LANGCHAIN COMPATIBILITY
  # ============================================================================
  langchain-compat:
    name: LangChain ${{ matrix.langchain-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        langchain-version: ["0.2.0", "latest"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo
        working-directory: tenuo-python
        run: |
          pip install uv
          uv pip install --system maturin
          maturin build --release
          uv pip install --system target/wheels/*.whl

      - name: Verify import
        run: |
          python -c "import tenuo; print(f'tenuo {tenuo.__version__}')"
          python -c "from tenuo import Capability; print('Capability import OK')"

      - name: Install LangChain ${{ matrix.langchain-version }}
        run: |
          uv pip install --system pytest pytest-asyncio pydantic PyYAML
          if [ "${{ matrix.langchain-version }}" = "latest" ]; then
            uv pip install --system langchain langchain-core langchain-openai langgraph
          else
            uv pip install --system langchain-core==${{ matrix.langchain-version }}
          fi

      - name: Test LangChain integration
        working-directory: tenuo-python
        run: pytest tests/test_langchain_integration.py tests/test_langgraph.py -v

  # ============================================================================
  # SECURITY AUDIT
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache cargo-audit
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-0.18

      - name: Install cargo-audit
        run: command -v cargo-audit || cargo install cargo-audit --locked

      - name: Audit tenuo-core
        working-directory: tenuo-core
        run: cargo audit

      - name: Audit tenuo-python
        working-directory: tenuo-python
        run: cargo audit

  # ============================================================================
  # DOCKER
  # ============================================================================
  docker:
    name: Docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build Control Plane
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.control
          push: false
          tags: tenuo/control:test
          cache-from: type=gha,scope=control
          cache-to: type=gha,mode=max,scope=control

      - name: Build Authorizer
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.authorizer
          push: false
          tags: tenuo/authorizer:test
          cache-from: type=gha,scope=authorizer
          cache-to: type=gha,mode=max,scope=authorizer

  # ============================================================================
  # NOTEBOOKS & EXAMPLES
  # ============================================================================
  notebooks-examples:
    name: Notebooks & Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo and dependencies
        working-directory: tenuo-python
        run: |
          pip install uv
          uv pip install --system maturin
          maturin build --release
          uv pip install --system target/wheels/*.whl
          uv pip install --system langchain langchain-core langgraph fastapi httpx pydantic PyYAML
          uv pip install --system nbmake pytest ipykernel

      - name: Test Notebooks
        run: |
          pytest --nbmake notebooks/*.ipynb -v --nbmake-timeout=120

      - name: Test Examples (syntax check)
        working-directory: tenuo-python/examples
        run: |
          # Syntax check all examples
          for f in *.py; do
            echo "Checking $f..."
            python -m py_compile "$f"
          done

      - name: Run Self-Contained Examples
        working-directory: tenuo-python/examples
        run: |
          # Run examples that don't need external APIs
          echo "=== basic_usage.py ==="
          python basic_usage.py
          echo ""
          echo "=== tier1_demo.py ==="
          python tier1_demo.py
          echo ""
          echo "=== orchestrator_worker.py ==="
          python orchestrator_worker.py || echo "Skipped (may need async)"

  # ============================================================================
  # EXPLORER (WASM + React)
  # ============================================================================
  explorer:
    name: Explorer Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-wasm

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM
        working-directory: tenuo-wasm
        run: wasm-pack build --target web --out-dir ../tenuo-explorer/src/wasm

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: tenuo-explorer/package-lock.json

      - name: Install dependencies
        working-directory: tenuo-explorer
        run: npm ci

      - name: Run tests
        working-directory: tenuo-explorer
        run: npm test -- --run

      - name: Verify WASM files in source
        run: |
          echo "=== WASM files in src/wasm ==="
          ls -la tenuo-explorer/src/wasm/
          echo "=== Check .wasm file exists ==="
          ls -la tenuo-explorer/src/wasm/*.wasm || echo "No .wasm files!"
          
      - name: Build Explorer (skip prebuild, WASM already built)
        working-directory: tenuo-explorer
        run: npx tsc && npx vite build

      - name: Verify WASM in build output
        run: |
          echo "=== Check dist for WASM ==="
          find tenuo-explorer/dist -name "*.wasm" -o -name "*wasm*" | head -20
          echo "=== dist/assets contents ==="
          ls -la tenuo-explorer/dist/assets/ | head -20

      # E2E tests disabled - WASM loading issues in CI environment
      # TODO: Debug locally and re-enable
      # - name: Run E2E tests
      #   working-directory: tenuo-explorer
      #   run: npm run test:e2e -- --project=chromium

      - name: Verify build output
        run: |
          echo "=== Checking asset paths ==="
          grep -o 'src="/explorer/assets/[^"]*"' tenuo-explorer/dist/index.html || echo "JS path check"
          grep -o 'href="/explorer/assets/[^"]*"' tenuo-explorer/dist/index.html || echo "CSS path check"
          echo "=== Build contents ==="
          ls -la tenuo-explorer/dist/
          ls -la tenuo-explorer/dist/assets/

      - name: Upload explorer artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: explorer-build
          path: tenuo-explorer/dist/
          retention-days: 1

  # ============================================================================
  # DOC CODE BLOCKS
  # ============================================================================
  doc-examples:
    name: Doc Code Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
          # No pip caching - this job doesn't install pip packages

      - name: Check for deprecated APIs in docs
        run: |
          # Fail if docs contain old API patterns (exclude auto-generated reference/)
          ERRORS=0
          
          if grep -rE '\.attenuate\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found .attenuate() - use .grant_builder().grant()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'Warrant\.issue\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found Warrant.issue() - use Warrant.mint_builder().mint()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'Constraints\.for_tool\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found Constraints.for_tool() - use Capability()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'protect_tools\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found protect_tools() - use guard_tools()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo "Found $ERRORS deprecated API pattern(s) in docs"
            exit 1
          fi
          
          echo "✅ No deprecated API patterns found in docs"

  # ============================================================================
  # CODE COVERAGE
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: llvm-tools-preview

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-core

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Rust coverage
        working-directory: tenuo-core
        run: |
          cargo llvm-cov --all-features --lcov --output-path lcov-rust.info

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Install Tenuo and test dependencies
        working-directory: tenuo-python
        run: |
          pip install uv
          uv pip install --system maturin pytest pytest-cov pytest-asyncio
          uv pip install --system langchain langchain-core langgraph fastapi pydantic PyYAML
          uv pip install --system crewai
          maturin build --release
          uv pip install --system target/wheels/*.whl

      - name: Python coverage
        working-directory: tenuo-python
        run: |
          pytest --cov=tenuo --cov-report=xml --cov-report=term-missing -q

      - name: Upload Rust coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: tenuo-core/lcov-rust.info
          flags: rust
          name: rust-coverage
          fail_ci_if_error: false

      - name: Upload Python coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: tenuo-python/coverage.xml
          flags: python
          name: python-coverage
          fail_ci_if_error: false

  # ============================================================================
  # PERFORMANCE REGRESSION
  # ============================================================================
  performance:
    name: Performance Regression
    runs-on: ubuntu-latest
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Configure mold linker
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-core

      - name: Run benchmarks
        working-directory: tenuo-core
        run: |
          cargo bench --bench warrant_benchmarks -- --noplot 2>&1 | tee benchmark-results.txt

      - name: Check performance thresholds
        working-directory: tenuo-core
        run: |
          # Extract key benchmark times and check against thresholds
          # We claim ~27μs verification - fail if critical operations exceed thresholds
          
          echo "=== Benchmark Results Summary ==="
          
          # Check warrant_verify (should be <100μs)
          if grep -q "warrant_verify" benchmark-results.txt; then
            LINE=$(grep "warrant_verify" benchmark-results.txt | head -1)
            echo "$LINE"
          fi
          
          # Check warrant_authorize (should be <150μs with PoP)
          if grep -q "warrant_authorize" benchmark-results.txt; then
            LINE=$(grep "warrant_authorize" benchmark-results.txt | head -1)
            echo "$LINE"
          fi
          
          # Check constraint evaluations
          for constraint in "pattern_match" "exact_match" "range_check" "subpath"; do
            if grep -q "$constraint" benchmark-results.txt; then
              LINE=$(grep "$constraint" benchmark-results.txt | head -1)
              echo "$LINE"
            fi
          done
          
          echo ""
          echo "✅ Benchmarks completed (threshold checks are informational)"

      - name: Upload benchmark results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: tenuo-core/benchmark-results.txt
          retention-days: 30

  # ============================================================================
  # BENCHMARK VALIDATION
  # ============================================================================
  benchmark-validation:
    name: Benchmark Harness Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Install Tenuo
        working-directory: tenuo-python
        run: |
          pip install uv
          uv pip install --system maturin
          maturin build --release
          uv pip install --system target/wheels/*.whl

      - name: Install benchmark dependencies
        run: |
          uv pip install --system -r benchmarks/agentdojo/requirements.txt

      - name: Validate benchmark imports
        run: |
          # Verify benchmark modules can be imported
          python -c "from benchmarks.agentdojo import tool_wrapper, warrant_templates"
          echo "Benchmark modules import successfully"

      - name: Validate constraint templates
        run: |
          python << 'EOF'
          from benchmarks.agentdojo.warrant_templates import get_constraints_for_suite
          for suite in ['workspace', 'banking', 'slack', 'travel']:
              constraints = get_constraints_for_suite(suite)
              print(f'{suite}: {len(constraints)} tool constraints defined')
          EOF
