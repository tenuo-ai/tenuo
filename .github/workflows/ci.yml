name: CI

on:
  push:
    branches: [main, camel]
  pull_request:
    branches: [main, camel]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # RUST CORE
  # ============================================================================
  rust-core:
    name: Rust Core
    runs-on: ubuntu-latest
    steps:
      # Pin to specific commit for security (update periodically)
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-core

      - name: Check Cargo.lock
        run: cargo check --locked
        working-directory: tenuo-core

      - name: Format tenuo-core
        run: cargo fmt --all -- --check
        working-directory: tenuo-core

      - name: Format tenuo-python
        run: cargo fmt --all -- --check
        working-directory: tenuo-python

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: tenuo-core

      - name: Test
        run: cargo test --all-features
        working-directory: tenuo-core

  # ============================================================================
  # PYTHON SDK
  # ============================================================================
  python-sdk:
    name: Python ${{ matrix.python-version }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Full Python version testing on Linux x64, key versions on other platforms/archs
        include:
          # Linux x64: full version matrix
          - os: ubuntu-latest
            python-version: "3.9"
          - os: ubuntu-latest
            python-version: "3.10"
          - os: ubuntu-latest
            python-version: "3.11"
          - os: ubuntu-latest
            python-version: "3.12"
          - os: ubuntu-latest
            python-version: "3.13"
          - os: ubuntu-latest
            python-version: "3.14"
          # Linux ARM64: min and latest
          - os: ubuntu-24.04-arm
            python-version: "3.9"
          - os: ubuntu-24.04-arm
            python-version: "3.14"
          # macOS ARM64 (Apple Silicon): full range
          - os: macos-latest
            python-version: "3.9"
          - os: macos-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.13"
          - os: macos-latest
            python-version: "3.14"
          # Windows x64: full range
          - os: windows-latest
            python-version: "3.9"
          - os: windows-latest
            python-version: "3.12"
          - os: windows-latest
            python-version: "3.13"
          - os: windows-latest
            python-version: "3.14"
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python
          key: ${{ matrix.os }}-py${{ matrix.python-version }}

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo and dependencies
        working-directory: tenuo-python
        run: |
          pip install maturin
          echo "=== Building wheel ==="
          maturin build --release
          echo "=== Wheel files ==="
          ls -la target/wheels/
          echo "=== Wheel contents ==="
          python -c "import zipfile; z=zipfile.ZipFile(list(__import__('pathlib').Path('target/wheels').glob('*.whl'))[0]); print('\n'.join(z.namelist()[:30]))"
          echo "=== Installing wheel ==="
          pip install target/wheels/*.whl
          echo "=== Pip show tenuo ==="
          pip show tenuo || echo "tenuo not found in pip"
          echo "=== Site packages ==="
          ls -la $(python -c "import site; print(site.getsitepackages()[0])") | head -20
          echo "=== Installing other deps ==="
          pip install pytest pytest-asyncio ruff mypy
          pip install langchain langchain-core langchain-openai langgraph
          pip install fastapi uvicorn pydantic PyYAML
          pip install types-PyYAML types-requests
          # MCP SDK requires Python 3.10+
          python -c "import sys; sys.exit(0 if sys.version_info >= (3, 10) else 1)" && pip install mcp || echo "Skipping MCP (requires Python 3.10+)"

      - name: Verify import
        run: |
          echo "=== Checking if tenuo_core exists ==="
          python -c "import tenuo_core; print('tenuo_core OK')" || echo "tenuo_core not found"
          echo "=== Checking if tenuo exists ==="
          python -c "import tenuo; print(f'tenuo {tenuo.__version__} from {tenuo.__file__}')"

      - name: Lint
        working-directory: tenuo-python
        run: ruff check .

      - name: Type check
        working-directory: tenuo-python
        run: mypy .

      - name: Test
        working-directory: tenuo-python
        run: pytest -v

  # ============================================================================
  # LANGCHAIN COMPATIBILITY
  # ============================================================================
  langchain-compat:
    name: LangChain ${{ matrix.langchain-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        langchain-version: ["0.2.0", "latest"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo
        working-directory: tenuo-python
        run: |
          pip install maturin
          maturin build --release
          pip install target/wheels/*.whl

      - name: Verify import
        run: |
          python -c "import tenuo; print(f'tenuo {tenuo.__version__}')"
          python -c "from tenuo import Capability; print('Capability import OK')"

      - name: Install LangChain ${{ matrix.langchain-version }}
        run: |
          pip install pytest pytest-asyncio pydantic PyYAML
          if [ "${{ matrix.langchain-version }}" = "latest" ]; then
            pip install langchain langchain-core langchain-openai langgraph
          else
            pip install langchain-core==${{ matrix.langchain-version }}
          fi

      - name: Test LangChain integration
        working-directory: tenuo-python
        run: pytest tests/test_langchain_integration.py tests/test_langgraph.py -v

  # ============================================================================
  # SECURITY AUDIT
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache cargo-audit
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-0.18

      - name: Install cargo-audit
        run: command -v cargo-audit || cargo install cargo-audit --locked

      - name: Audit tenuo-core
        working-directory: tenuo-core
        run: cargo audit

      - name: Audit tenuo-python
        working-directory: tenuo-python
        run: cargo audit

  # ============================================================================
  # DOCKER
  # ============================================================================
  docker:
    name: Docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build Control Plane
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.control
          push: false
          tags: tenuo/control:test
          cache-from: type=gha,scope=control
          cache-to: type=gha,mode=max,scope=control

      - name: Build Authorizer
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          context: tenuo-core
          file: tenuo-core/deploy/docker/Dockerfile.authorizer
          push: false
          tags: tenuo/authorizer:test
          cache-from: type=gha,scope=authorizer
          cache-to: type=gha,mode=max,scope=authorizer

  # ============================================================================
  # NOTEBOOKS & EXAMPLES
  # ============================================================================
  notebooks-examples:
    name: Notebooks & Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: tenuo-python/pyproject.toml

      - name: Install Tenuo and dependencies
        working-directory: tenuo-python
        run: |
          pip install maturin
          maturin build --release
          pip install target/wheels/*.whl
          pip install langchain langchain-core langgraph fastapi httpx pydantic PyYAML
          pip install nbmake pytest ipykernel

      - name: Test Notebooks
        run: |
          pytest --nbmake notebooks/*.ipynb -v --nbmake-timeout=120

      - name: Test Examples (syntax check)
        working-directory: tenuo-python/examples
        run: |
          # Syntax check all examples
          for f in *.py; do
            echo "Checking $f..."
            python -m py_compile "$f"
          done

      - name: Run Self-Contained Examples
        working-directory: tenuo-python/examples
        run: |
          # Run examples that don't need external APIs
          echo "=== basic_usage.py ==="
          python basic_usage.py
          echo ""
          echo "=== tier1_demo.py ==="
          python tier1_demo.py
          echo ""
          echo "=== orchestrator_worker.py ==="
          python orchestrator_worker.py || echo "Skipped (may need async)"

  # ============================================================================
  # EXPLORER (WASM + React)
  # ============================================================================
  explorer:
    name: Explorer Build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-wasm

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM
        working-directory: tenuo-wasm
        run: wasm-pack build --target web --out-dir ../tenuo-explorer/src/wasm

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: tenuo-explorer/package-lock.json

      - name: Install dependencies
        working-directory: tenuo-explorer
        run: npm ci

      - name: Run tests
        working-directory: tenuo-explorer
        run: npm test -- --run

      - name: Verify WASM files in source
        run: |
          echo "=== WASM files in src/wasm ==="
          ls -la tenuo-explorer/src/wasm/
          echo "=== Check .wasm file exists ==="
          ls -la tenuo-explorer/src/wasm/*.wasm || echo "No .wasm files!"
          
      - name: Build Explorer (skip prebuild, WASM already built)
        working-directory: tenuo-explorer
        run: npx tsc && npx vite build

      - name: Verify WASM in build output
        run: |
          echo "=== Check dist for WASM ==="
          find tenuo-explorer/dist -name "*.wasm" -o -name "*wasm*" | head -20
          echo "=== dist/assets contents ==="
          ls -la tenuo-explorer/dist/assets/ | head -20

      # E2E tests disabled - WASM loading issues in CI environment
      # TODO: Debug locally and re-enable
      # - name: Run E2E tests
      #   working-directory: tenuo-explorer
      #   run: npm run test:e2e -- --project=chromium

      - name: Verify build output
        run: |
          echo "=== Checking asset paths ==="
          grep -o 'src="/explorer/assets/[^"]*"' tenuo-explorer/dist/index.html || echo "JS path check"
          grep -o 'href="/explorer/assets/[^"]*"' tenuo-explorer/dist/index.html || echo "CSS path check"
          echo "=== Build contents ==="
          ls -la tenuo-explorer/dist/
          ls -la tenuo-explorer/dist/assets/

      - name: Deploy to docs/explorer
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          rm -rf docs/explorer
          mkdir -p docs/explorer
          cp -r tenuo-explorer/dist/* docs/explorer/
          
      - name: Commit explorer build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/explorer/
          if ! git diff --staged --quiet; then
            git commit -m "chore(explorer): auto-deploy from CI"
            # Pull with rebase to handle concurrent pushes, retry up to 3 times
            for i in 1 2 3; do
              git pull --rebase origin main && git push && break
              echo "Push failed, retrying ($i/3)..."
              sleep 2
            done
          fi

  # ============================================================================
  # DOC CODE BLOCKS
  # ============================================================================
  doc-examples:
    name: Doc Code Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
          # No pip caching - this job doesn't install pip packages

      - name: Check for deprecated APIs in docs
        run: |
          # Fail if docs contain old API patterns (exclude auto-generated reference/)
          ERRORS=0
          
          if grep -rE '\.attenuate\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found .attenuate() - use .grant_builder().grant()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'Warrant\.issue\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found Warrant.issue() - use Warrant.mint_builder().mint()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'Constraints\.for_tool\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found Constraints.for_tool() - use Capability()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if grep -rE 'protect_tools\(' docs/ --include='*.md' | grep -v 'docs/reference/'; then
            echo "❌ Found protect_tools() - use guard_tools()"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo "Found $ERRORS deprecated API pattern(s) in docs"
            exit 1
          fi
          
          echo "✅ No deprecated API patterns found in docs"

  # ============================================================================
  # BENCHMARK VALIDATION
  # ============================================================================
  benchmark-validation:
    name: Benchmark Harness Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable
        with:
          toolchain: stable

      - name: Cache Rust
        uses: swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tenuo-python

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install Tenuo
        working-directory: tenuo-python
        run: |
          pip install maturin
          maturin build --release
          pip install target/wheels/*.whl

      - name: Install benchmark dependencies
        run: |
          pip install numpy pandas matplotlib seaborn

      - name: Validate benchmark imports
        run: |
          # Verify all benchmark modules can be imported
          python -c "from benchmarks.agentdojo import harness, tool_wrapper, warrant_templates"
          echo "✅ Benchmark modules import successfully"

      - name: Validate constraint templates
        run: |
          python -c "
from benchmarks.agentdojo.warrant_templates import get_constraints_for_suite
for suite in ['workspace', 'banking', 'slack', 'travel']:
    constraints = get_constraints_for_suite(suite)
    print(f'✅ {suite}: {len(constraints)} tool constraints defined')
"
