name: Integration Compatibility Matrix

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Manual trigger
  pull_request:
    paths:
      - 'tenuo-python/tenuo/openai.py'
      - 'tenuo-python/tenuo/crewai.py'
      - 'tenuo-python/tenuo/autogen.py'
      - 'tenuo-python/tenuo/langchain.py'
      - 'tenuo-python/tenuo/langgraph.py'
      - 'tenuo-python/pyproject.toml'

permissions:
  contents: read
  issues: write

jobs:
  test-compatibility:
    name: ${{ matrix.integration }} @ ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        integration:
          - openai
          - crewai
          - autogen
          - langchain
          - langgraph
        version:
          - minimum  # Minimum supported version
          - latest   # Latest stable
        python-version: ['3.11']

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e "tenuo-python[dev]"

      - name: Install minimum version
        if: matrix.version == 'minimum'
        run: |
          case "${{ matrix.integration }}" in
            openai)
              # openai 1.0-1.5 have httpx compatibility issues, use 1.6+
              pip install "openai==1.6.0"
              ;;
            crewai)
              # crewai 1.0 has many missing required fields, use 1.1+
              pip install "crewai==1.1.0"
              ;;
            autogen)
              pip install "autogen-agentchat==0.7.0" "autogen-ext[openai]==0.7.0"
              ;;
            langchain)
              pip install "langchain-core==0.2.0"
              ;;
            langgraph)
              # langgraph 0.0.x requires langchain-core<0.2, use 0.2+ for langchain-core>=0.2
              pip install "langgraph==0.2.0" "langchain-core==0.2.0"
              ;;
          esac

      - name: Install latest version
        if: matrix.version == 'latest'
        run: |
          pip install "tenuo[${{ matrix.integration }}]"

      - name: Show installed versions
        run: |
          pip list | grep -E "(openai|crewai|autogen|langchain|langgraph)"

      - name: Run smoke tests (API contracts)
        run: |
          pytest tenuo-python/tests/integration/test_smoke.py \
            -k "test_${{ matrix.integration }}" \
            -v --tb=short

      - name: Run integration tests
        run: |
          # Run integration-specific tests if they exist
          pytest tenuo-python/tests/ \
            -k "${{ matrix.integration }}" \
            --ignore=tenuo-python/tests/integration/ \
            -v --tb=short || echo "No integration tests found"

      - name: Check for deprecation warnings
        run: |
          pytest tenuo-python/tests/integration/test_smoke.py \
            -k "test_${{ matrix.integration }}" \
            -W error::DeprecationWarning \
            -W error::PendingDeprecationWarning \
            --tb=short || echo "::warning::Deprecation warnings detected in ${{ matrix.integration }}"

      - name: Report compatibility failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Integration] ${{ matrix.integration }} ${{ matrix.version }} compatibility issue`;
            const body = `
            ## Integration Test Failure

            **Integration**: ${{ matrix.integration }}
            **Version**: ${{ matrix.version }}
            **Python**: ${{ matrix.python-version }}
            **Workflow**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Action Items
            - [ ] Review test logs
            - [ ] Check for breaking changes in upstream changelog
            - [ ] Update integration code if needed
            - [ ] Update minimum version in pyproject.toml if needed
            - [ ] Update compatibility matrix documentation

            ### Upstream Resources
            ${{ matrix.integration == 'openai' && '- [OpenAI Changelog](https://github.com/openai/openai-python/releases)' || '' }}
            ${{ matrix.integration == 'crewai' && '- [CrewAI Changelog](https://github.com/joaomdmoura/crewAI/releases)' || '' }}
            ${{ matrix.integration == 'autogen' && '- [AutoGen Changelog](https://github.com/microsoft/autogen/releases)' || '' }}
            ${{ matrix.integration == 'langchain' && '- [LangChain Changelog](https://python.langchain.com/changelog)' || '' }}
            ${{ matrix.integration == 'langgraph' && '- [LangGraph Changelog](https://github.com/langchain-ai/langgraph/releases)' || '' }}
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['integration', 'breaking-change', '${{ matrix.integration }}', 'automated']
            });
